from fastapi import APIRouter, HTTPException
from models.types import DraftInput, RecommendationResponse
from services.logic import generate_recommendation
import logging

router = APIRouter(
    prefix="/api",
    tags=["recommendation"]
)

@router.post(
    "/recommend",
    response_model=RecommendationResponse,
    summary="üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –≥–µ—Ä–æ—è –∏ –±–∏–ª–¥–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥—Ä–∞—Ñ—Ç–∞",
    response_description="–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≥–µ—Ä–æ–µ–≤, —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –±–∏–ª–¥–æ–≤ —Å —É—á—ë—Ç–æ–º –ª–∏–Ω–∏–∏"
)
async def recommend_team(draft: DraftInput):
    """
    üß† –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π –¥—Ä–∞—Ñ—Ç –≤ Dota 2 –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –≥–µ—Ä–æ—è –∏ –±–∏–ª–¥.

    ### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
    - **user_role**: –í–∞—à–∞ —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Mid, Support, Carry –∏ —Ç.–¥.)

    ### –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
    - **user_hero**: –ì–µ—Ä–æ–π, –∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏–≥—Ä–∞—Ç—å
    - **ally_heroes**: –°–ø–∏—Å–æ–∫ –≥–µ—Ä–æ–µ–≤ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã (–¥–æ 4)
    - **enemy_heroes**: –°–ø–∏—Å–æ–∫ –≥–µ—Ä–æ–µ–≤ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (–¥–æ 5)

    ### –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è:
    - –¢–æ–ø-3 –≥–µ—Ä–æ—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º–æ–π (–µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≥–µ—Ä–æ–π)
    - –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏ –ø–æ –ª–∏–Ω–∏–∏ (2 –ø–µ—Ä–≤—ã—Ö –≤—Ä–∞–≥–∞)
    - –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    - –ë–∏–ª–¥—ã –¥–ª—è –ª—ë–≥–∫–æ–π, —Ä–∞–≤–Ω–æ–π –∏ —Ç—è–∂—ë–ª–æ–π –∏–≥—Ä—ã
    - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ –≤—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º
    """
    try:
        logging.info("üîç –ü–æ–ª—É—á–µ–Ω –¥—Ä–∞—Ñ—Ç: %s", draft.dict())
        result = generate_recommendation(draft)
        logging.info("‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: %s", result)
        return result

    except ValueError as ve:
        logging.warning("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: %s", ve)
        raise HTTPException(status_code=400, detail=str(ve))

    except FileNotFoundError as fnf:
        logging.error("üìÅ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö: %s", fnf)
        raise HTTPException(status_code=500, detail="–§–∞–π–ª —Å –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.")

    except Exception as e:
        logging.critical("üí• –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: %s", e, exc_info=True)
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.")
